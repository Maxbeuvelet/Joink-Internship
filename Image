from arcgis import GIS
from IPython.display import display
from arcgis.features import FeatureLayerCollection
from arcgis.features import FeatureLayer
from PIL import Image
from PyPDF2 import PdfMerger
from fpdf import FPDF

gis = GIS('home')
int_point = gis.content.get('e3796b16d9484709963a1cc2984cf325')

search_results = gis.content.search('title: FTTH TQ','Feature Layer')
picture = search_results[0]

# Prints Feature Layer
FTTH = search_results[0]

FTTH

FTTH_layers = FTTH.layers


Number_Order = input("Enter Order Number ")

def picture():
    pdf = FPDF()
    pdf.add_page()
    TQData = gis.content.get('e3796b16d9484709963a1cc2984cf325')
    templates ={"FTTH_TQ_CablePlacement":"Template-CablePlacement","FTTH_TQ_ISP":"Template-ISP","FTTH_TQ_OSP":"Template-OSP"}
    for l in templates:

        Layout = templates[l]

        #getting Attachments from AGO
        #Feature Server
        TQData = gis.content.get('e3796b16d9484709963a1cc2984cf325')
        #Layout Variables
        GISLayouts={"Template-ISP":[0,r'\ISP'], "Template-OSP":[1,r'\OSP'], "Template-CablePlacement":[2,r'\OSP']}
        LayoutV = GISLayouts[Layout]
        LryNum = LayoutV[0]
        ImagePath = LayoutV[1]
        OutputPath = r"C:\Users\max.beuvelet\Desktop\FTTH Project"
        
    



    TQLayers = TQData.layers[1]
    #query featuers 
    TQFeatureSet = TQLayers.query(where='OrderNumber='+Number_Order,out_fields='OBJECTID')
    #get object ids
    ObjIDs = [x.attributes['OBJECTID'] for x in TQFeatureSet]
    print(ObjIDs)
    for x in ObjIDs:
        y=TQLayers.attachments.get_list(oid=x)
        for img in y:
            #print(img['id'])
            dwn = TQLayers.attachments.download(oid=x, attachment_id=img['id'])
            #print(dwn[0])
            #print(dwn)


    for ids in ObjIDs:
        arcpy.AddMessage(ids)
        attach = TQLayers.attachments.get_list(oid=ids)
        for att in attach:
            DwnFile = TQLayers.attachments.download(oid=ids, attachment_id=att['id'],save_path=OutputPath+ImagePath )
            arcpy.AddMessage(DwnFile)
            

            
    #print(DwnFile)
    pdf.image("{}".format(dwn[0]),x=100,y=20,w=50)# x and y move the image up,down,left or right, w increases or decrease size
    pdf.output('eno.pdf')
    

    
    
    pdfs = [r"C:\Users\max.beuvelet\Documents\ArcGIS\Projects\pythontest\GFG.pdf", r'C:\Users\max.beuvelet\Desktop\FTTH Project\pic.pdf']


    merger = PdfMerger()

    for pdf in pdfs:
        merger.append(pdf)

    merger.write("endingresults.pdf")
    merger.close()

picture()
